<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">

<title>Person in yuor Note</title>

<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="description" content="Personal Website Template">
<meta name="keywords" content="Personal, Website Template, Minimal HTML Template, Freelancer">
<meta name="author" content="khai tawng">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/animate.css">
<link rel="stylesheet" href="css/magnific-popup.css">
<link rel="stylesheet" href="css/font-awesome.min.css">

<!-- amazyi css-->
<link rel="stylesheet" href="amazeui.min.css">
<link rel="stylesheet" href="app.css">
<!-- editor-->
<link rel="stylesheet" href="editor.md/css/editormd.css" />

<!-- Main css -->
<link rel="stylesheet" href="css/style.css">

<style>
   #div_insert{
     margin: 0 0 30px 0;
   }  
</style>
</head>
<body data-spy="scroll" data-target=".navbar-collapse" data-offset="50">

     <div id="app">
<!-- PRE LOADER -->
<div class="preloader">
     <div class="spinner">
          <span class="spinner-rotate"></span>
     </div>
</div>


<!-- NAVIGATION SECTION -->
<div class="navbar custom-navbar navbar-fixed-top" role="navigation">
     <div class="container">

          <div class="navbar-header">
               <button class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon icon-bar"></span>
                    <span class="icon icon-bar"></span>
                    <span class="icon icon-bar"></span>
               </button>
               <!-- lOGO TEXT HERE -->
               <a href="index.html" class="navbar-brand">To User</a>
          </div>

          <div class="collapse navbar-collapse">
               <ul class="nav navbar-nav navbar-right">
                    <li><a class="smoothScroll" href="admin.html">Home</a></li>
                    <li><a class="smoothScroll" href="#about">About Jack Doe</a></li>
                    <li><a class="smoothScroll" href="#work">My Works</a></li>
                    <li><a class="smoothScroll" href="#contact">Contact</a></li>
               </ul>
          </div>

     </div>
</div>




<!-- SKILL SECTION -->
<section id="skill">
     <div class="container" v-show="status == 'blog_list'">



               
          </div>
     <!-- 编辑博客窗口-->
     <div class="container">
          <!--标题框-->
        <div class="am-form">   
        <div class="am-form-group">
            <label for="doc-ipt-email-1">博客标题</label>
            <input type="text" class="" id="blog_title" >
        </div>
        </div>
          <article id="blog_view">
               <!-- 先使用 editor.md 完成 markdown 到 html 的转换-->
               <textarea></textarea>
          </article>
          <button type="button" class="am-btn am-btn-success am-round" v-on:click="insert_blog()" onclick="location.href='admin.html'">提交</button>
          <button type="button" class="am-btn am-btn-success am-round" v-on:click="back()" onclick="location.href='admin.html'">返回</button>
     </div>
     <div class="blog-clear-margin blog-sidebar-widget blog-bor am-g ">
          <h2 class="blog-title"><span>Choose Tag</span></h2>
          <div class="am-u-sm-12 blog-clear-padding">
               <a  class="blog-tag" v-for="tag in tags" v-on:click="get(tag.tag_id,$event)">{{tag.tag_name}}</a>
     
          </div>
     </div>
     </section>


<!-- WORK SECTION -->

<!-- CONTACT SECTION -->
<section id="contact" v-show="status == 'blog_list'">
     <div class="container">
          <div class="row">
>

               <div class="col-md-12 col-sm-12">
                     <!-- CONTACT FORM HERE -->

                    More Templates <a href="http://www.cssmoban.com/" target="_blank" title="模板之家">模板之家</a> - Collect from <a href="http://www.cssmoban.com/" title="网页模板" target="_blank">网页模板</a>
               </div>

          </div>
     </div>
</section>
</div>



<!-- SCRIPTS -->
<script src="js/jquery.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/smoothscroll.js"></script>
<script src="js/jquery.magnific-popup.min.js"></script>
<script src="js/magnific-popup-options.js"></script>
<script src="js/wow.min.js"></script>
<script src="js/custom.js"></script>
<!-- vue 链接-->
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

<!--editor 链接-->
<script src="editor.md/lib/marked.min.js"></script>
<script src="editor.md/lib/prettify.min.js"></script>
<script src="editor.md/lib/raphael.min.js"></script>
<script src="editor.md/lib/underscore.min.js"></script>
<script src="editor.md/lib/sequence-diagram.min.js"></script>
<script src="editor.md/lib/flowchart.min.js"></script>
<script src="editor.md/lib/jquery.flowchart.min.js"></script>

<script src="editor.md/editormd.js"></script>

<script>
     var app = new Vue({
          el: '#app',  // el 表示 app 这个 Vue 对象和哪个 HTML 元素关联上
          data: {
               // data表示所有需要在页面上动态变化的数据
               // 把 js 中的数据和界面上的内容关联在一起，数据绑定的过程
               author: 'KeXin',
               blogs: [
               ],
               tags: [
               ],
               // blog 对象用来保存当前页面上展示的博客的详细内容
               blog: {
                    blog_id: null,
                    title: null,
                    content: null,
                    create_time: null,
                    tag_id: null,
               },
               status: 'blog_list',
               _tag_id: 0
          },
          methods: {
               name2tag_id(tag_name){
                    for(var index in this.tags){
                         if(this.tags[index].tag_name == tag_name){
                              return this.tags[index].tag_id;
                         }
                    }
                    return 1;
               },
               tag_id2name(tag_id) {
                    // this 访问到当前的 app 对象
                    // this.tags 就相当于上面定义的标签数组
                    for (var index in this.tags) {
                         if (this.tags[index].tag_id == tag_id) {
                              return this.tags[index].tag_name;
                         }
                    }
                    return "默认分类";
               },
               get_blogs(tag_id) {
                    var url = '/blog';
                    // null 空引用 非法对象
                    if (tag_id != null) {
                         url = '/blog/?tagid=' + tag_id;
                    }
                    // 最核心操作，访问http服务器的数据
                    // ajax 原生 API 特别难用, Vue 也提供了 API 但是环境配置起来比较麻烦
                    // 此处我们使用 JQuery 提供的 API
                    $.ajax({
                         url: url,
                         type: 'get',
                         context: this, // 此处的 this 表示 Vue 对象
                         success(data, status) {
                              // data 表示响应的 body 数据
                              // status 表示响应的状态码
                              // HTTP 请求执行成功之后要执行的代码
                              // 在这个代码中更新数据
                              // 如果不设置 context ， 此时直接使用 this.blogs 会出现错误
                              // 因为此时的 this 表示当前 $ 这样的 jquery 对象
                              // 加上 context 之后， this 就表示 context 中的值
                              this.blogs = data;
                         }
                    })
               },
               init() {
                    // 1. 从服务器上获取 tag
                    $.ajax({
                         type: "get",
                         url: "/tag",
                         context: this,
                         success: function (data, status) {
                              this.tags = data;
                              // 2. 从服务器上获取 博客
                              // 写在外边 并行执行
                              // 因为需要先获取到 tag 信息 在获取 博客列表， 否则 tag_id 和 tag_name 映射关系无法正确建立.
                              this.get_blogs();
                         }
                    }),
               this.insert_edit_blog()
               },
               // 点击博客标题调用 这个函数
               get_blog(blog_id) {
                    $.ajax({
                         url: '/blog/' + blog_id,
                         type: "get",
                         context: this,
                         success(data, status) {
                              // 此时得到的 blog.content 是 markdowm 格式的数据
                              this.blog = data;
                              //$('#test-editormd-view').empty();
                              // 把这个 markdown 数据转换到 html 格式 并且展示在网页上
                              testEditormdView = editormd.markdownToHTML("blog_view", {
                                   markdown: this.blog.content,//+ "\r\n" + $("#append-test").text(),
                                   //htmlDecode      : true,       // 开启 HTML 标签解析，为了安全性，默认不开启
                                   htmlDecode: "style,script,iframe",  // you can filter tags decode
                                   //toc             : false,
                                   tocm: true,    // Using [TOCM]
                                   //tocContainer    : "#custom-toc-container", // 自定义 ToC 容器层
                                   //gfm             : false,
                                   //tocDropdown     : true,
                                   // markdownSourceCode : true, // 是否保留 Markdown 源码，即是否删除保存源码的 Textarea 标签
                                   emoji: true,
                                   taskList: true,
                                   tex: true,  // 默认不解析
                                   flowChart: true,  // 默认不解析
                                   sequenceDiagram: true,  // 默认不解析
                              });
                              this.status = 'blog_get'
                         }
                    })
               },
               delete_blog(blog_id) {
                    $.ajax({
                         type: "delete",
                         url: '/blog/' + blog_id,
                         context: this,
                         success: function (data, status) {
                              this.get_blogs();
                              alert("删除成功");
                         }
                    })
               },
               main_page() {
                    this.status = 'blog_list';
               },
               edit_blog(blog_id) {
                    // 1. 先把之前的博客数据先清空
                    this.blog = {};
                    // 2. ajax 获取到当前点击的博客内容
                    $.ajax({
                         type: "get",
                         url: "/blog/" + blog_id,
                         context: this,
                         success: function (data, status) {
                              this.blog = data;
                              // 3. 根据数据加载 markdown 编辑器
                              testEditor = editormd("blog_view", {
                                   width: "90%",
                                   height: "700px",
                                   syncScrolling: "single",
                                   path: "editor.md/lib/"
                              });
                              this.status = 'blog_edit'
                         }
                    })
               },
               insert_edit_blog() {
                    this.blog = {};

                    $(function () {
                         InsertEditor = editormd("blog_view", {
                              width: "90%",
                              height: 640,
                              syncScrolling: "single",
                              path: "editor.md/lib/"
                         });

                         /*
                         // or
                         testEditor = editormd({
                             id      : "test-editormd",
                             width   : "90%",
                             height  : 640,
                             path    : "../lib/"
                         });
                         */
                    });


                    this.status = 'insert_blog_edit'
               },
               back() {
                    this.blog = {};
                    this.status = 'blog_list'
               },
               update_blog(blog_id) {
                    // 从编辑器过去修改后的 markdown
                    var content = testEditor.getMarkdown();
                    var body = {
                         title: this.blog.title,
                         content: content, // 这是修改后的内容
                         tag_id: this.blog.tag_id
                    }
                    $.ajax({
                         type: "put",
                         url: "/blog/" + blog_id,
                         data: JSON.stringify(body),
                         contentType: 'application/json;charset=utf-8',
                         context: this,
                         success: function (data, status) {
                              this.get_blogs();
                              alert("提交成功");
                              this.back();
                         }

                    })
               },
               get: function(tag_id,event){
                    this._tag_id = tag_id;
                    var el = event.currentTarget;
                    console.log("当前对象的内容" + el.innerHTML);
                    console.log(this._tag_id)
               },
               insert_blog() {
                    var title = document.getElementById("blog_title");
                    var content = InsertEditor.getMarkdown();
                    var date = new Date();
                    var create_time = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate();
                    console.log(this._tag_id)
                    var tag_id = this._tag_id;
                    var body = {
                         title: title.value, 
                         content: content,
                         create_time: create_time,
                         tag_id: tag_id
                    }
                    $.ajax({
                         type: "post",
                         url: "/blog",
                         data: JSON.stringify(body),
                         contentType: 'application/json;charset=utf-8',
                         context: this,
                         success(data, status) {
                              alert("新增成功");
                              this.back;
                         }

                    })
               }
          },
     });
     // 初始化的获取数据操作
     app.init();
</script>

</body>
</html>